name: Build Release Artifacts

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      build_target:
        description: 'Build target'
        required: true
        default: 'samp'
        type: choice
        options:
          - samp
          - omp

env:
  CONFIG: Release

jobs:

  linux-docker:
    name: Build Linux .so (32-bit)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Prepare build folder
        run: |
          mkdir -p docker/build
          sudo chown 1000:1000 docker/build

      - name: Build Docker image
        run: |
          docker build -t randomix/build:ubuntu-22.04 docker/build_ubuntu-22.04/

      - name: Determine build type
        id: build_type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "BUILD_TYPE=${{ github.event.inputs.build_target }}" >> $GITHUB_OUTPUT
          else
            # Default to SA-MP for tag pushes
            echo "BUILD_TYPE=samp" >> $GITHUB_OUTPUT
          fi

      - name: Build (SA-MP)
        if: steps.build_type.outputs.BUILD_TYPE == 'samp'
        run: |
          docker run --rm -t \
            -w /code \
            -v "${{ github.workspace }}:/code" \
            -v "${{ github.workspace }}/docker/build:/code/build" \
            -e CONFIG=${{ env.CONFIG }} \
            -e BUILD_SAMP_PLUGIN=1 \
            randomix/build:ubuntu-22.04

      - name: Build (open.mp)
        if: steps.build_type.outputs.BUILD_TYPE == 'omp'
        run: |
          docker run --rm -t \
            -w /code \
            -v "${{ github.workspace }}:/code" \
            -v "${{ github.workspace }}/docker/build:/code/build" \
            -e CONFIG=${{ env.CONFIG }} \
            -e BUILD_SAMP_PLUGIN=0 \
            randomix/build:ubuntu-22.04

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: randomix-linux
          path: docker/build/Randomix.so

  windows:
    name: Build Windows .dll (32-bit)
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
    
      - name: Determine build type
        id: build_type
        shell: powershell
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            echo "BUILD_TYPE=${{ github.event.inputs.build_target }}" >> $env:GITHUB_OUTPUT
          } else {
            # Default to SA-MP for tag pushes
            echo "BUILD_TYPE=samp" >> $env:GITHUB_OUTPUT
          }
    
      - name: Configure CMake (SA-MP)
        if: steps.build_type.outputs.BUILD_TYPE == 'samp'
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -A Win32 -DCMAKE_BUILD_TYPE=Release -DBUILD_SAMP_PLUGIN=ON
        shell: powershell
    
      - name: Configure CMake (open.mp)
        if: steps.build_type.outputs.BUILD_TYPE == 'omp'
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -A Win32 -DCMAKE_BUILD_TYPE=Release
        shell: powershell
    
      - name: Build
        run: |
          cmake --build build --config Release --parallel
        shell: powershell
    
      - name: Check file size
        run: |
          Get-ChildItem -Path "build\Release\Randomix.dll" | Select-Object Name, @{N="SizeKB";E={[math]::Round($_.Length/1KB,2)}}
        shell: powershell
    
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: randomix-windows
          path: build/Release/Randomix.dll

  release:
    name: Create Release
    needs: [linux-docker, windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: |
          echo "=== Artifacts ==="
          find artifacts -type f \( -name "*.so" -o -name "*.dll" \) | sort

      - name: Rename artifacts
        run: |
          mkdir -p release
          cp artifacts/randomix-linux/Randomix.so release/Randomix-linux-x86.so
          cp artifacts/randomix-windows/Randomix.dll release/Randomix-win-x86.dll

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
