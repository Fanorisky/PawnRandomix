name: Build Release Artifacts

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

env:
  CONFIG: Release
  BUILD_SERVER: "1"

jobs:

  linux-docker:
    name: Build Linux .so (Docker 32-bit)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Prepare build folder (uid 1000 required by container)
        run: |
          mkdir -p docker/build
          sudo chown 1000:1000 docker/build

      - name: Build Docker image
        run: |
          docker build -t omp-easing-functions/build:ubuntu-18.04 docker/build_ubuntu-18.04/

      - name: Run build in Docker container
        env:
          CONFIG: ${{ env.CONFIG }}
          BUILD_SERVER: ${{ env.BUILD_SERVER }}
        run: |
          docker run --rm -t \
            -w /code \
            -v "${{ github.workspace }}:/code" \
            -v "${{ github.workspace }}/docker/build:/code/build" \
            -e CONFIG=${CONFIG} \
            -e BUILD_SERVER=${BUILD_SERVER} \
            omp-easing-functions/build:ubuntu-18.04

      - name: Upload Linux .so artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-so
          path: |
            docker/build/**/*.so
            docker/build/*.so

  windows-native:
    name: Build Windows .dll (Native Windows)
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [Win32, x64]  # Win32 untuk 32-bit, x64 untuk 64-bit
        config: [Release]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup vcpkg
      run: |
        git clone https://github.com/Microsoft/vcpkg.git
        cd vcpkg
        .\bootstrap-vcpkg.bat
      shell: cmd
    
    - name: Install dependencies
      run: |
        $triplet = if ("${{ matrix.arch }}" -eq "Win32") { "x86-windows-static" } else { "x64-windows-static" }
        Write-Host "Installing dependencies for triplet: $triplet"
        .\vcpkg\vcpkg.exe install --triplet $triplet
        if ($LASTEXITCODE -ne 0) {
          Write-Error "vcpkg install failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE
        }
      shell: powershell
    
    - name: Configure CMake
      run: |
        $triplet = if ("${{ matrix.arch }}" -eq "Win32") { "x86-windows-static" } else { "x64-windows-static" }
        $env:VCPKG_DEFAULT_TRIPLET = $triplet
        cmake -S . -B build -G "Visual Studio 17 2022" -A ${{ matrix.arch }} -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}\vcpkg\scripts\buildsystems\vcpkg.cmake" -DVCPKG_TARGET_TRIPLET="$triplet" -DCMAKE_BUILD_TYPE=${{ matrix.config }}
      shell: powershell
    
    - name: Build
      run: |
        cmake --build build --config ${{ matrix.config }} --parallel
      shell: powershell
    
    - name: Install
      run: |
        cmake --install build --config ${{ matrix.config }}
      shell: powershell

    - name: List build outputs
      run: |
        Write-Host "=== Build output files ==="
        Get-ChildItem -Recurse build -Include *.dll,*.lib,*.pdb,*.exe | Select-Object FullName, Length, LastWriteTime | Format-Table -AutoSize
      shell: powershell

    - name: Upload Windows DLL artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-dll-${{ matrix.arch }}
        path: |
          build/**/*.dll
          build/*.dll

# Versi yang lebih sederhana tanpa vcpkg (jika project tidak membutuhkan banyak dependencies)
  windows-simple:
    name: Build Windows .dll (Native Simple)
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [Win32, x64]
        config: [Release]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Configure CMake
      run: |
        cmake -S . -B build -G "Visual Studio 17 2022" -A ${{ matrix.arch }} -DCMAKE_BUILD_TYPE=${{ matrix.config }}
      shell: powershell
    
    - name: Build
      run: |
        cmake --build build --config ${{ matrix.config }} --parallel
      shell: powershell
    
    - name: Upload Windows DLL artifacts (simple)
      uses: actions/upload-artifact@v4
      with:
        name: windows-dll-simple-${{ matrix.arch }}
        path: |
          build/**/*.dll
          build/*.dll
